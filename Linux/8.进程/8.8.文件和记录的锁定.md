# 文件和记录的锁定
对应多个进程同时访问一个文件的情况，需要进行互斥，但是使用信号灯或共享内存的方式又十分复杂，所以 Linux 还提供了锁定机制，用于多进程对文件的互斥性访问  

**名词解释**：  
**记录**：指的是一个文件中从某一位置开始的连续字节流，Linux提供了对记录锁定的机制，用于锁定文件中的某一部分  

**共享锁/读锁**：多进程读操作可以同时进行，即某一进程读记录时，不排斥其它进程也读该记录，但是排斥任何对该记录的写操作  

**互斥锁/写锁**：当某进程写记录时，排斥所有其它进程对该记录的读和写  

## 咨询式锁定
``` C
int fcntl(int fd, int cmd, struct flock *lock);

// 结构体 flock 定义如下：
struct flock {
    short l_type;   // F_RDLCK 表示读锁，F_WRLCK 表示写锁，F_UNLCK 表示解锁
    short l_whence; // 指定坐标0的位置，SEEK_SET 表示文件首，SEEK_CUR 表示文件当前位置，SEEL_END 表示文件尾
    long l_start;   // 指定记录的起点字节，相对于坐标 0 的偏移量
    long l_len;     // 指定记录含有的字节数，为 0 时表示从起点到文件尾
};
```
咨询式锁定，指可能上锁成功，也可能失败(返回 -1)，并不是强制上锁的  
如果 cmd 置为 F_SETLKW 等待，则会阻塞直到可以上锁成功  
如果 cmd 取 F_SETLK (不等待)，则会立即返回值  

不等待并对某数据文件指定字节上写锁可以实现系统中同一个程序只许启动一次进程的要求  

